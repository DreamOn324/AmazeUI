<!doctype html>
<html class="no-js">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="description" content="">
  <meta name="keywords" content=""> 
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>西瓜虫演出</title>

  <!-- Set render engine for 360 browser -->
  <meta name="renderer" content="webkit"> 
 
  <!-- No Baidu Siteapp-->
  <meta http-equiv="Cache-Control" content="no-siteapp"/>

  <link rel="icon" type="image/png" href="assets/i/favicon.png">

  <!-- Add to homescreen for Chrome on Android -->
  <meta name="mobile-web-app-capable" content="yes">
  <link rel="icon" sizes="192x192" href="assets/i/app-icon72x72@2x.png">

  <!-- Add to homescreen for Safari on iOS -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="Amaze UI"/>
  <link rel="apple-touch-icon-precomposed" href="assets/i/app-icon72x72@2x.png">

  <!-- Tile icon for Win8 (144x144 + tile color) -->
  <meta name="msapplication-TileImage" content="assets/i/app-icon72x72@2x.png">
  <meta name="msapplication-TileColor" content="#0e90d2">

  <!-- SEO: If your mobile URL is different from the desktop URL, add a canonical link to the desktop page https://developers.google.com/webmasters/smartphone-sites/feature-phones -->
  <!--
  <link rel="canonical" href="http://www.example.com/">
  -->

  <link rel="stylesheet" href="assets/css/amazeui.min.css">
  <link rel="stylesheet" href="css/modifyPhone.css">   
  <link rel="stylesheet" href="css/base.css">
</head>
<body> 
<!--[if lte IE 9]>
<p class="browsehappy">你正在使用<strong>过时</strong>的浏览器，Amaze UI 暂不支持。 请 <a
  href="http://browsehappy.com/" target="_blank">升级浏览器</a>
  以获得更好的体验！</p>
<![endif]-->

  <!-- 页头 -->
  <header data-am-widget="header" class="am-header am-header-default">
    <div class="am-header-left am-header-nav">   
      <a href="myInfo.html" class="">     
        <img class="am-header-icon-custom" src="imgs/public/fanhui@2x.png" alt=""/>
      </a>
    </div> 
    <h1 class="am-header-title">          
      <span>修改手机号码</span>              
    </h1> 
  </header> 

  <div id="tip"></div>

  <!-- 内容块 -->
  <div id="content">    
    <input type="text" class="am-form-field" placeholder="新手机号" id="mobile">      
    <div class="validate"> 
      <input type="text" class="am-form-field" id="code" style="width: 65%;float: left;" placeholder="输入验证码">     
      <button type="button" id="codeBtn">获取验证码</button>
    </div>
    <button type="button" class="am-btn am-btn-default am-btn-block btn" id="btn">确认修改</button>
  </div>
<!--[if lt IE 9]>
<script src="http://libs.baidu.com/jquery/1.11.1/jquery.min.js"></script>
<script src="http://cdn.staticfile.org/modernizr/2.8.3/modernizr.js"></script>
<script src="assets/js/amazeui.ie8polyfill.min.js"></script>
<![endif]-->
  
<!--[if (gte IE 9)|!(IE)]><!-->
<script src="assets/js/jquery.min.js"></script>
<!--<![endif]-->   
<script src="assets/js/amazeui.min.js"></script> 
<script src="js/common.js"></script>
<script type="text/javascript"> 
  $(function(){ 
    var mobile = $('#mobile');     
    var code = $('#code');   
    var codeBtn = $('#codeBtn');
    var ls = window.localStorage;    
    var tip = $('#tip');    
     
    // 如果获得验证码后用户刷新了页面，则重置倒计时  
    console.log(ls.getItem('mobile'))
    if(ls.getItem('mobile')){            
      mobile.attr('value', ls.getItem('mobile'));                      
      timer(60);                        
    }      
   
    // 发送验证码      
    $('#codeBtn').click(function(){     
      if(!/^1\d{10}$/.test(trim(mobile.val()))){     // 手机号不合法          
        tipShowHide(tip, warning, '请填写正确的手机号！');                     
      }else{                   
        $.post('/Mobile/sendCode', {mobile: mobile.val()}, function(data){       
          if(data.state == 'fail'){      
            tipShowHide(tip, error, data.msg);                       
          }else{ 
            timer(60);                        
            if(ls){       
              ls.setItem('mobile', mobile.val());                                
            }else{                    
              console.log('浏览器不支持localStorage');                
            }    
          }                                           
        })                          
      }     
    })  

    // 修改手机号事件     
    $('#btn').click(function(){    
      if(!/^1\d{10}$/.test(trim(mobile.val()))){          
        tipShowHide(tip, warning, '请填写正确的手机号！');     // 手机号不合法                     
      }else if(!/^\d{6}$/.test(trim(code.val()))){     // 验证码不合法                
        tipShowHide(tip, warning, '验证码只能输入六位数字！');  
      }else{   
        var userObj = JSON.parse(ls.getItem('user'));          
        $.post('/Info/updateMobile', {userId: userObj.userId , mobile: mobile.val(), code: code.val()}, function(data){
          if(data.state == 'fail'){              
            tipShowHide(tip, error, data.msg);        
          }else{                      
            ls.setItem('newphoneNum', mobile.val());
            ls.removeItem('mobile');
            window.location.href = 'myInfo.html';               
          }      
        })       
      } 
    })  

    // 倒计时120秒，seconds为秒数        
    function timer(seconds){      
      var timer = setInterval(function(){     
        if(seconds == 0){         
          if(ls.getItem('mobile')){    
            ls.removeItem('mobile');    
          }            
          codeBtn.html('获取验证码');
          codeBtn.attr('disabled', 'enabled');   
          return;       
        }else{         
          codeBtn.html(seconds + '秒');        
          codeBtn.attr('disabled', 'disabled');
          seconds--; 
        }               
      }, 1000);        
    } 
  })  
</script>
</body>
</html>


